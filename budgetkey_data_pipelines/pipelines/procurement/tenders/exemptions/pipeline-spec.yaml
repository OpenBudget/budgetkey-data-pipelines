exemptions:
  pipeline:
    - run: add_metadata
      parameters:
        name: "procurement-tenders-exemptions"
    # get the main HTML page of the exemptions search
    - run: add_resource
      parameters:
        name: "mr-gov-il-search-exemption-messages"
        url: "http://www.mr.gov.il/ExemptionMessage/Pages/SearchExemptionMessages.aspx"
        format: "txt"
    # download it (using tzabar runner which does some magic that bypasses network security)
    - run: stream_remote_resources
      runner: tzabar
    # parse all the publisher ids from the main search page
    - run: add_exemptions_publishers_resource
    # go over each publisher and get urls for all exemptions related to this publisher
    # max_pages parameter can be used to limit number of pages for each publisher
    - run: add_publisher_urls_resource
      runner: tzabar
      parameters:
        # meant for running in cronjob every day
        # for a one-time download of all data set environment variable: EXEMPTION_PUBLISHERS_MAX_PAGES=-1
        max_pages: 2
    # download the data from each exemption page
    - run: download_exemption_pages_data
    # parse the data for each exemption
    - run: parse_exemption_data
    - run: dump.to_path
      parameters:
        out-path: /var/datapackages/procurement/tenders/exemptions
    # remove the documents json field before updating SQL
    - run: set_types
      parameters:
        resources:
          exemptions
        types:
          documents_json: null
    # update the SQL table (based on the primary keys defined in the schemas)
    - run: dump.to_sql
      parameters:
        tables:
          procurement_tenders_exemptions:
            mode: update
            resource-name: exemptions

exemption-documents:
  pipeline:
    - run: add_metadata
      parameters:
        name: "procurement-tenders-exemption-documents"
    # add the exemption documents resource from the previously saved exemption data
    - run: add_resource
      parameters:
        name: "exemptions"
        url: /var/datapackages/procurement/tenders/exemptions/data/exemptions.csv
    - run: stream_remote_resources
    # convert the exemption resource to documents resource
    - run: convert_to_documents_resource
    - run: dump.to_path
      parameters:
        out-path: /var/datapackages/procurement/tenders/exemption-documents
    # update the documents in SQL
    - run: dump.to_sql
      parameters:
        tables:
          procurement_tenders_exemption_documents:
            mode: update
            resource-name: exemption-documents
